pipeline {

  agent {
    kubernetes {
      yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
    - name: node
      image: ritesh57/ci-tools:latest
      command: ['cat']
      tty: true

    - name: docker
      image: docker:24
      command: ['cat']
      tty: true
      volumeMounts:
        - name: docker-sock
          mountPath: /var/run/docker.sock

    - name: trivy
      image: aquasec/trivy:latest
      command: ['cat']
      tty: true

  volumes:
    - name: docker-sock
      hostPath:
        path: /var/run/docker.sock
"""
      defaultContainer 'node'
    }
  }

  environment {
    REGISTRY = "ritesh57"
    IMAGE_NAME = "application-code-frontend"
    IMAGE_TAG = "${BUILD_NUMBER}"
    HELM_VALUES_FILE = "ArgoCD/frontend/values.yaml"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Install Dependencies') {
      steps {
        container('node') {
          dir('Application-Code/frontend') {
            sh '''
              npm config set registry https://registry.npmjs.org/
              npm ci --no-audit --progress=false
            '''
          }
        }
      }
    }

    stage('Unit Tests') {
      steps {
        container('node') {
          dir('Application-Code/frontend') {
            sh 'npm test -- --passWithNoTests'
          }
        }
      }
    }

    stage('SonarQube Analysis') {
      environment {
        SONAR_SCANNER_HOME = tool 'sonar-scanner'
      }
      steps {
        container('node') {
          dir('Application-Code/frontend') {
            withSonarQubeEnv('sonarqube-server') {
              sh """
                ${SONAR_SCANNER_HOME}/bin/sonar-scanner \
                  -Dsonar.projectKey=frontend \
                  -Dsonar.projectName=frontend \
                  -Dsonar.sources=src
              """
            }
          }
        }
      }
    }

    stage('Quality Gate') {
      steps {
        timeout(time: 5, unit: 'MINUTES') {
          waitForQualityGate abortPipeline: true
        }
      }
    }

    stage('Trivy FS Scan') {
      steps {
        container('trivy') {
          dir('Application-Code/frontend') {
            sh 'trivy fs --exit-code 1 --severity HIGH,CRITICAL .'
          }
        }
      }
    }

    stage('Docker Build') {
      steps {
        container('docker') {
          dir('Application-Code/frontend') {
            sh """
              docker build -t ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} .
            """
          }
        }
      }
    }

    stage('Docker Push') {
      steps {
        container('docker') {
          withCredentials([usernamePassword(
            credentialsId: 'dockerhub-creds',
            usernameVariable: 'DOCKER_USER',
            passwordVariable: 'DOCKER_PASS'
          )]) {
            sh """
              echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
              docker push ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}
            """
          }
        }
      }
    }

    stage('Update Helm Values') {
      steps {
        sh """
          yq e '.image.tag = "${IMAGE_TAG}"' -i ${HELM_VALUES_FILE}
        """
      }
    }

    stage('Git Commit & Push') {
      steps {
        withCredentials([usernamePassword(
          credentialsId: 'git-creds',
          usernameVariable: 'GIT_USER',
          passwordVariable: 'GIT_PASS'
        )]) {
          sh """
            git config user.email "ci@jenkins"
            git config user.name "jenkins-ci"
            git add ${HELM_VALUES_FILE}
            git commit -m "chore(frontend): bump image to ${IMAGE_TAG}" || echo "No changes to commit"
            git push https://${GIT_USER}:${GIT_PASS}@github.com/RiteshKaushal57/End-to-End-DevOps-Project.git HEAD:main
          """
        }
      }
    }
  }
}
